From 8977b898f13b117bd7a76131ccded7ae27a91969 Mon Sep 17 00:00:00 2001
From: Georgi Djakov <georgi.djakov@linaro.org>
Date: Wed, 19 Apr 2017 16:09:23 +0300
Subject: cpufreq-dt: Drop RCU for OPPs

OPPs are not using RCU anymore.

Signed-off-by: Georgi Djakov <georgi.djakov@linaro.org>
---
 drivers/cpufreq/cpufreq-dt.c | 15 +++------------
 1 file changed, 3 insertions(+), 12 deletions(-)

diff --git a/drivers/cpufreq/cpufreq-dt.c b/drivers/cpufreq/cpufreq-dt.c
index ee3b1eb..251aa24 100644
--- a/drivers/cpufreq/cpufreq-dt.c
+++ b/drivers/cpufreq/cpufreq-dt.c
@@ -195,7 +195,6 @@ static int cpufreq_init(struct cpufreq_policy *policy)
 	bool fallback = false;
 	const char *name;
 	int ret;
-	struct srcu_notifier_head *opp_srcu_head;
 
 	cpu_dev = get_cpu_device(policy->cpu);
 	if (!cpu_dev) {
@@ -284,17 +283,9 @@ static int cpufreq_init(struct cpufreq_policy *policy)
 
 	mutex_init(&priv->lock);
 
-	rcu_read_lock();
-	opp_srcu_head = dev_pm_opp_get_notifier(cpu_dev);
-	if (IS_ERR(opp_srcu_head)) {
-		ret = PTR_ERR(opp_srcu_head);
-		rcu_read_unlock();
-		goto out_free_priv;
-	}
-
 	priv->opp_nb.notifier_call = opp_notifier;
-	ret = srcu_notifier_chain_register(opp_srcu_head, &priv->opp_nb);
-	rcu_read_unlock();
+	ret = dev_pm_opp_register_notifier(cpu_dev, &priv->opp_nb);
+
 	if (ret)
 		goto out_free_priv;
 
@@ -341,7 +332,7 @@ static int cpufreq_init(struct cpufreq_policy *policy)
 out_free_cpufreq_table:
 	dev_pm_opp_free_cpufreq_table(cpu_dev, &freq_table);
 out_unregister_nb:
-	srcu_notifier_chain_unregister(opp_srcu_head, &priv->opp_nb);
+	dev_pm_opp_unregister_notifier(cpu_dev, &priv->opp_nb);
 out_free_priv:
 	kfree(priv);
 out_free_opp:
-- 
cgit 
